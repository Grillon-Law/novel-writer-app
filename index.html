<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="AI 驱动的小说创作助手">
    <meta name="theme-color" content="#1f2937">
    <title>小说创作助手</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"小说创作助手","short_name":"创作助手","description":"AI 驱动的小说创作助手","start_url":"./","display":"standalone","background_color":"#ffffff","theme_color":"#1f2937","scope":"./","icons":[{"src":"data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 192 192%22><rect fill=%22%231f2937%22 width=%22192%22 height=%22192%22/><text x=%2250%%22 y=%2250%%22 font-size=%22100%22 fill=%22white%22 text-anchor=%22middle%22 dominant-baseline=%22central%22 font-family=%22serif%22>✍</text></svg>","sizes":"192x192","type":"image/svg+xml","purpose":"any"}]}'>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231f2937' width='100' height='100'/><text x='50' y='55' font-size='60' fill='white' text-anchor='middle' font-family='serif'>✍</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%231f2937' width='180' height='180' rx='40'/><text x='90' y='95' font-size='80' fill='white' text-anchor='middle' font-family='serif'>✍</text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        .dark {
            color-scheme: dark;
        }
        
        .light {
            color-scheme: light;
        }
        
        /* 虚拟键盘避让 */
        .input-area {
            transition: transform 0.3s ease;
        }
        
        /* 流式输出打字机效果 */
        .streaming::after {
            content: '▌';
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }
        
        /* 响应式容器 */
        .safe-area {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        
        /* 禁用缩放 */
        input, textarea, select {
            font-size: 16px;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="light bg-white text-gray-900">
    <div id="app" class="flex flex-col h-screen w-screen safe-area">
        <!-- 顶部导航 -->
        <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-gray-700 dark:bg-gray-900 dark:text-white bg-white">
            <h1 class="text-lg font-bold">小说创作助手</h1>
            <div class="flex gap-2">
                <button id="themeBtn" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                </button>
                <button id="settingsBtn" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- 主容器 -->
        <div class="flex flex-1 overflow-hidden">
            <!-- 左侧：场景选择器（平板及以上显示） -->
            <div id="sceneSidebar" class="hidden lg:flex lg:w-64 flex-col border-r border-gray-200 dark:border-gray-700 dark:bg-gray-900 bg-gray-50 overflow-y-auto scrollbar-hide">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-sm font-semibold mb-3">场景列表</h2>
                    <button id="addSceneBtn" class="w-full px-3 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition">
                        + 新建场景
                    </button>
                </div>
                <div id="sceneList" class="flex-1 overflow-y-auto scrollbar-hide"></div>
            </div>

            <!-- 右侧：主写作区 -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <!-- 场景信息条（手机显示） -->
                <div id="mobileSceneBar" class="lg:hidden px-4 py-3 border-b border-gray-200 dark:border-gray-700 dark:bg-gray-800 bg-gray-50 flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-xs text-gray-500 dark:text-gray-400">当前场景</p>
                        <p id="mobileSceneName" class="text-sm font-semibold truncate">未选择</p>
                    </div>
                    <button id="mobileSceneMenuBtn" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 5a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V5zM3 13a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2z"></path>
                        </svg>
                    </button>
                </div>

                <!-- 对话区 -->
                <div id="chatContainer" class="flex-1 overflow-y-auto scrollbar-hide p-4 space-y-4">
                    <div class="text-center text-gray-400 dark:text-gray-500 text-sm py-8">
                        <p>选择一个场景开始创作</p>
                    </div>
                </div>

                <!-- 输入区 -->
                <div class="input-area border-t border-gray-200 dark:border-gray-700 dark:bg-gray-900 bg-white p-4">
                    <div class="flex gap-2">
                        <textarea id="userInput" placeholder="输入创作指令或提示..." class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 max-h-24" rows="2"></textarea>
                        <button id="sendBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-medium disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            发送
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 设置模态框 -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end lg:items-center lg:justify-center">
        <div class="bg-white dark:bg-gray-900 w-full lg:w-96 rounded-t-2xl lg:rounded-2xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold">设置</h2>
                <button id="closeSettingsBtn" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>

            <div class="space-y-6">
                <!-- API Key 输入 -->
                <div>
                    <label class="block text-sm font-semibold mb-2">OpenRouter API Key</label>
                    <input type="password" id="apiKeyInput" placeholder="sk-or-..." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">从 <a href="https://openrouter.ai" target="_blank" class="text-blue-500 hover:underline">openrouter.ai</a> 获取</p>
                </div>

                <!-- 模型选择 -->
                <div>
                    <label class="block text-sm font-semibold mb-2">选择模型</label>
                    <select id="modelSelect" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="anthropic/claude-sonnet-4.5">Claude Sonnet 4.5 (精细写作)</option>
                        <option value="anthropic/claude-3.5-haiku">Claude 3.5 Haiku (快速迭代)</option>
                        <option value="google/gemini-1.5-flash">Gemini 1.5 Flash (便宜)</option>
                        <option value="google/gemini-2.0-flash-exp" selected>Gemini 2.0 Flash Exp (免费)</option>
                    </select>
                </div>

                <!-- 底层设定编辑 -->
                <div>
                    <label class="block text-sm font-semibold mb-2">底层设定 (全局)</label>
                    <textarea id="basePromptEdit" placeholder="小说总大纲、人物卡、时间线、写作禁忌等..." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 h-40"></textarea>
                </div>

                <!-- 保存按钮 -->
                <button id="saveSettingsBtn" class="w-full px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-medium">
                    保存设置
                </button>
            </div>
        </div>
    </div>

    <!-- 场景编辑模态框 -->
    <div id="sceneModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end lg:items-center lg:justify-center">
        <div class="bg-white dark:bg-gray-900 w-full lg:w-96 rounded-t-2xl lg:rounded-2xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold">场景设定</h2>
                <button id="closeSceneModalBtn" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>

            <div class="space-y-4">
                <!-- 场景名称 -->
                <div>
                    <label class="block text-sm font-semibold mb-2">场景名称</label>
                    <input type="text" id="sceneNameInput" placeholder="e.g. 咖啡馆初遇" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- 场景设定 -->
                <div>
                    <label class="block text-sm font-semibold mb-2">场景设定 (中层)</label>
                    <textarea id="scenePromptEdit" placeholder="年代、背景、人物状态、冲突、情节目标、伏笔等..." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 h-40"></textarea>
                </div>

                <!-- 操作按钮 -->
                <div class="flex gap-2">
                    <button id="saveSceneBtn" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-medium">
                        保存
                    </button>
                    <button id="deleteSceneBtn" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-medium">
                        删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 移动端场景菜单 -->
    <div id="mobileSceneMenu" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-end">
        <div class="bg-white dark:bg-gray-900 w-full rounded-t-2xl p-6 max-h-[70vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold">场景列表</h2>
                <button id="closeMobileMenuBtn" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            <div id="mobileSceneList" class="space-y-2 mb-4"></div>
            <button id="addSceneBtnMobile" class="w-full px-3 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition">
                + 新建场景
            </button>
        </div>
    </div>

    <script>
        // ============ 应用状态 ============
        const app = {
            apiKey: '',
            model: 'google/gemini-2.0-flash-exp',
            basePrompt: '',
            scenes: [],
            currentSceneId: null,
            conversationHistory: [],
            isDarkMode: false,
            isLoading: false
        };

        // ============ DOM 元素缓存 ============
        const elements = {
            app: document.getElementById('app'),
            themeBtn: document.getElementById('themeBtn'),
            settingsBtn: document.getElementById('settingsBtn'),
            settingsModal: document.getElementById('settingsModal'),
            closeSettingsBtn: document.getElementById('closeSettingsBtn'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            modelSelect: document.getElementById('modelSelect'),
            basePromptEdit: document.getElementById('basePromptEdit'),
            saveSettingsBtn: document.getElementById('saveSettingsBtn'),
            
            sceneModal: document.getElementById('sceneModal'),
            closeSceneModalBtn: document.getElementById('closeSceneModalBtn'),
            sceneNameInput: document.getElementById('sceneNameInput'),
            scenePromptEdit: document.getElementById('scenePromptEdit'),
            saveSceneBtn: document.getElementById('saveSceneBtn'),
            deleteSceneBtn: document.getElementById('deleteSceneBtn'),
            
            sceneList: document.getElementById('sceneList'),
            addSceneBtn: document.getElementById('addSceneBtn'),
            
            mobileSceneBar: document.getElementById('mobileSceneBar'),
            mobileSceneName: document.getElementById('mobileSceneName'),
            mobileSceneMenuBtn: document.getElementById('mobileSceneMenuBtn'),
            mobileSceneMenu: document.getElementById('mobileSceneMenu'),
            closeMobileMenuBtn: document.getElementById('closeMobileMenuBtn'),
            mobileSceneList: document.getElementById('mobileSceneList'),
            addSceneBtnMobile: document.getElementById('addSceneBtnMobile'),
            
            chatContainer: document.getElementById('chatContainer'),
            userInput: document.getElementById('userInput'),
            sendBtn: document.getElementById('sendBtn'),
            inputArea: document.querySelector('.input-area')
        };

        // ============ 数据持久化 ============
        function loadFromStorage() {
            const stored = localStorage.getItem('novelWriterData');
            if (stored) {
                const data = JSON.parse(stored);
                app.apiKey = data.apiKey || '';
                app.model = data.model || 'google/gemini-2.0-flash-exp';
                app.basePrompt = data.basePrompt || '';
                app.scenes = data.scenes || [];
                app.isDarkMode = data.isDarkMode || false;
            }
            applyTheme();
        }

        function saveToStorage() {
            const data = {
                apiKey: app.apiKey,
                model: app.model,
                basePrompt: app.basePrompt,
                scenes: app.scenes,
                isDarkMode: app.isDarkMode
            };
            localStorage.setItem('novelWriterData', JSON.stringify(data));
        }

        // ============ 主题切换 ============
        function applyTheme() {
            if (app.isDarkMode) {
                elements.app.classList.add('dark');
                elements.app.classList.remove('light');
            } else {
                elements.app.classList.add('light');
                elements.app.classList.remove('dark');
            }
        }

        elements.themeBtn.addEventListener('click', () => {
            app.isDarkMode = !app.isDarkMode;
            applyTheme();
            saveToStorage();
        });

        // ============ 设置面板 ============
        elements.settingsBtn.addEventListener('click', () => {
            elements.apiKeyInput.value = app.apiKey;
            elements.modelSelect.value = app.model;
            elements.basePromptEdit.value = app.basePrompt;
            elements.settingsModal.classList.remove('hidden');
        });

        elements.closeSettingsBtn.addEventListener('click', () => {
            elements.settingsModal.classList.add('hidden');
        });

        elements.saveSettingsBtn.addEventListener('click', () => {
            app.apiKey = elements.apiKeyInput.value.trim();
            app.model = elements.modelSelect.value;
            app.basePrompt = elements.basePromptEdit.value.trim();
            saveToStorage();
            elements.settingsModal.classList.add('hidden');
            alert('设置已保存');
        });

        // ============ 场景管理 ============
        function generateSceneId() {
            return 'scene_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function renderSceneList() {
            elements.sceneList.innerHTML = '';
            elements.mobileSceneList.innerHTML = '';

            app.scenes.forEach(scene => {
                const sceneItem = document.createElement('div');
                sceneItem.className = `p-3 cursor-pointer rounded-lg transition ${
                    app.currentSceneId === scene.id
                        ? 'bg-blue-500 text-white'
                        : 'hover:bg-gray-100 dark:hover:bg-gray-800'
                }`;
                sceneItem.textContent = scene.name;
                sceneItem.addEventListener('click', () => selectScene(scene.id));
                elements.sceneList.appendChild(sceneItem);

                // 移动端菜单
                const mobileItem = sceneItem.cloneNode(true);
                mobileItem.addEventListener('click', () => {
                    selectScene(scene.id);
                    elements.mobileSceneMenu.classList.add('hidden');
                });
                elements.mobileSceneList.appendChild(mobileItem);
            });
        }

        function selectScene(sceneId) {
            app.currentSceneId = sceneId;
            app.conversationHistory = [];
            elements.chatContainer.innerHTML = '<div class="text-center text-gray-400 dark:text-gray-500 text-sm py-8"><p>开始创作...</p></div>';
            renderSceneList();
            updateMobileSceneBar();
            saveToStorage();
        }

        function updateMobileSceneBar() {
            const scene = app.scenes.find(s => s.id === app.currentSceneId);
            elements.mobileSceneName.textContent = scene ? scene.name : '未选择';
        }

        function openSceneModal(sceneId = null) {
            if (sceneId) {
                const scene = app.scenes.find(s => s.id === sceneId);
                elements.sceneNameInput.value = scene.name;
                elements.scenePromptEdit.value = scene.prompt;
                elements.deleteSceneBtn.style.display = 'block';
                elements.sceneModal.dataset.sceneId = sceneId;
            } else {
                elements.sceneNameInput.value = '';
                elements.scenePromptEdit.value = '';
                elements.deleteSceneBtn.style.display = 'none';
                elements.sceneModal.dataset.sceneId = '';
            }
            elements.sceneModal.classList.remove('hidden');
        }

        elements.addSceneBtn.addEventListener('click', () => openSceneModal());
        elements.addSceneBtnMobile.addEventListener('click', () => {
            elements.mobileSceneMenu.classList.add('hidden');
            openSceneModal();
        });

        elements.closeSceneModalBtn.addEventListener('click', () => {
            elements.sceneModal.classList.add('hidden');
        });

        elements.saveSceneBtn.addEventListener('click', () => {
            const name = elements.sceneNameInput.value.trim();
            const prompt = elements.scenePromptEdit.value.trim();

            if (!name) {
                alert('请输入场景名称');
                return;
            }

            const sceneId = elements.sceneModal.dataset.sceneId;
            if (sceneId) {
                const scene = app.scenes.find(s => s.id === sceneId);
                scene.name = name;
                scene.prompt = prompt;
            } else {
                app.scenes.push({
                    id: generateSceneId(),
                    name: name,
                    prompt: prompt
                });
            }

            saveToStorage();
            renderSceneList();
            elements.sceneModal.classList.add('hidden');
        });

        elements.deleteSceneBtn.addEventListener('click', () => {
            if (confirm('确定删除此场景？')) {
                const sceneId = elements.sceneModal.dataset.sceneId;
                app.scenes = app.scenes.filter(s => s.id !== sceneId);
                if (app.currentSceneId === sceneId) {
                    app.currentSceneId = null;
                }
                saveToStorage();
                renderSceneList();
                elements.sceneModal.classList.add('hidden');
            }
        });

        // ============ 移动端场景菜单 ============
        elements.mobileSceneMenuBtn.addEventListener('click', () => {
            elements.mobileSceneMenu.classList.remove('hidden');
        });

        elements.closeMobileMenuBtn.addEventListener('click', () => {
            elements.mobileSceneMenu.classList.add('hidden');
        });

        // 点击场景列表项编辑
        document.addEventListener('click', (e) => {
            if (e.target.closest('#sceneList > div')) {
                const sceneItem = e.target.closest('#sceneList > div');
                const sceneName = sceneItem.textContent;
                const scene = app.scenes.find(s => s.name === sceneName);
                if (scene && e.detail > 1) { // 双击编辑
                    openSceneModal(scene.id);
                }
            }
        });

        // ============ 对话与 API 调用 ============
        async function sendMessage() {
            if (!app.apiKey) {
                alert('请先在设置中填写 API Key');
                return;
            }

            if (!app.currentSceneId) {
                alert('请先选择一个场景');
                return;
            }

            const userMessage = elements.userInput.value.trim();
            if (!userMessage) return;

            app.isLoading = true;
            elements.sendBtn.disabled = true;

            // 添加用户消息到对话历史
            app.conversationHistory.push({
                role: 'user',
                content: userMessage
            });

            // 显示用户消息
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'flex justify-end';
            userMsgDiv.innerHTML = `<div class="max-w-xs bg-blue-500 text-white px-4 py-2 rounded-lg">${escapeHtml(userMessage)}</div>`;
            elements.chatContainer.appendChild(userMsgDiv);
            elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;

            elements.userInput.value = '';
            elements.userInput.style.height = 'auto';

            // 构建 System Prompt
            const scene = app.scenes.find(s => s.id === app.currentSceneId);
            const systemPrompt = `${app.basePrompt}\n\n【当前场景】\n${scene?.prompt || ''}`;

            // 构建消息列表
            const messages = [
                ...app.conversationHistory.map(msg => ({
                    role: msg.role,
                    content: msg.content
                }))
            ];

            try {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${app.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: app.model,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            ...messages
                        ],
                        stream: true
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || '请求失败');
                }

                // 显示 AI 回复
                const assistantMsgDiv = document.createElement('div');
                assistantMsgDiv.className = 'flex justify-start';
                const assistantContent = document.createElement('div');
                assistantContent.className = 'max-w-xs bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 rounded-lg streaming';
                assistantMsgDiv.appendChild(assistantContent);
                elements.chatContainer.appendChild(assistantMsgDiv);

                let fullResponse = '';
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;

                            try {
                                const json = JSON.parse(data);
                                const content = json.choices[0]?.delta?.content || '';
                                if (content) {
                                    fullResponse += content;
                                    assistantContent.classList.remove('streaming');
                                    assistantContent.textContent = fullResponse;
                                    assistantContent.classList.add('streaming');
                                    elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
                                }
                            } catch (e) {
                                // 忽略解析错误
                            }
                        }
                    }
                }

                assistantContent.classList.remove('streaming');
                assistantContent.textContent = fullResponse;

                // 添加 AI 回复到对话历史
                app.conversationHistory.push({
                    role: 'assistant',
                    content: fullResponse
                });

            } catch (error) {
                console.error('API 错误:', error);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'flex justify-start';
                errorDiv.innerHTML = `<div class="max-w-xs bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-100 px-4 py-2 rounded-lg text-sm">错误: ${escapeHtml(error.message)}</div>`;
                elements.chatContainer.appendChild(errorDiv);
                elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
            } finally {
                app.isLoading = false;
                elements.sendBtn.disabled = false;
                elements.userInput.focus();
            }
        }

        elements.sendBtn.addEventListener('click', sendMessage);
        elements.userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey && !app.isLoading) {
                e.preventDefault();
                sendMessage();
            }
        });

        // 自动调整输入框高度
        elements.userInput.addEventListener('input', () => {
            elements.userInput.style.height = 'auto';
            elements.userInput.style.height = Math.min(elements.userInput.scrollHeight, 96) + 'px';
        });

        // 虚拟键盘避让
        window.visualViewport?.addEventListener('resize', () => {
            const inputRect = elements.userInput.getBoundingClientRect();
            const viewportHeight = window.visualViewport.height;
            if (inputRect.top > viewportHeight) {
                elements.inputArea.style.transform = `translateY(-${inputRect.top - viewportHeight + 10}px)`;
            } else {
                elements.inputArea.style.transform = 'translateY(0)';
            }
        });

        // ============ 工具函数 ============
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // ============ Service Worker 注册 ============
        if ('serviceWorker' in navigator) {
            const swCode = `
                self.addEventListener('install', (e) => {
                    e.waitUntil(
                        caches.open('novel-writer-v1').then((cache) => {
                            return cache.addAll(['/']);
                        })
                    );
                });

                self.addEventListener('fetch', (e) => {
                    if (e.request.method !== 'GET') return;
                    
                    e.respondWith(
                        caches.match(e.request).then((response) => {
                            return response || fetch(e.request);
                        })
                    );
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            navigator.serviceWorker.register(swUrl).catch(err => console.log('SW 注册失败:', err));
        }

        // ============ 初始化 ============
        loadFromStorage();
        renderSceneList();

        // 防止缩放
        document.addEventListener('touchmove', (e) => {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });

        document.addEventListener('gesturestart', (e) => {
            e.preventDefault();
        });
    </script>
</body>
</html>
